services:
  ngrok:
    container_name: ngrok
    image: ngrok/ngrok:latest
    network_mode: host
    restart: unless-stopped
    stdin_open: true
    tty: true
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    command:
      http --url=${NGROK_URL} 80
      # 접근 제한(권장): Basic Auth
      # - "--basic-auth=${NGROK_BASIC_AUTH}"
      # 헤더 보존/프록시 관련(선택)
      # - "--host-header=rewrite"
    depends_on:
      - nginx

  nginx:
    container_name: nginx
    image: nginx:1.25.3
    depends_on:
      - frontend
      - backend
    ports:
      - "80:80"
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app_net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: app_frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_BASE=/api
    networks:
      - app_net
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: app_backend
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=postgresql+psycopg://app:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    depends_on:
      - db
    networks:
      - app_net
    restart: unless-stopped

  db:
    image: postgres:18
    container_name: app_db
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./db:/var/lib/postgresql
    networks:
      - app_net
    restart: unless-stopped
    # 외부 노출 불필요(권장)
    # ports:
    #   - "5432:5432"

volumes:
  pgdata:

networks:
  app_net:
    driver: bridge
