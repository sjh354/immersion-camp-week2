services:
  nginx:
    image: nginx:1.27-alpine
    container_name: app_nginx
    depends_on:
      - frontend
      - backend
    ports:
      # 내부에서 직접 접속 테스트용(필요 없으면 주석 처리 가능)
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - app_net
    restart: unless-stopped

  ngrok:
    image: ngrok/ngrok:latest
    container_name: app_ngrok
    depends_on:
      - nginx
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    command:
      - "http"
      - "nginx:80"
      # 기본 HTTPS 도메인 발급됨
      # 접근 제한(권장): Basic Auth
      - "--basic-auth=${NGROK_BASIC_AUTH}"
      # 헤더 보존/프록시 관련(선택)
      - "--host-header=rewrite"
    networks:
      - app_net
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: app_frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_BASE=/api
    networks:
      - app_net
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: app_backend
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=postgresql+psycopg://app:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      # ngrok 뒤라서 프록시 헤더를 신뢰하려면 Flask에서 ProxyFix 사용 권장(아래 참고)
    depends_on:
      - db
    networks:
      - app_net
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: app_db
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - app_net
    restart: unless-stopped
    # 외부 노출 불필요(권장)
    # ports:
    #   - "5432:5432"

volumes:
  pgdata:

networks:
  app_net:
    driver: bridge
