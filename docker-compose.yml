services:
  # ngrok:
    # container_name: ngrok
    # image: ngrok/ngrok:latest
    # network_mode: host
    # restart: unless-stopped
    # stdin_open: true
    # tty: true
    # environment:
    #   - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    # command:
    #   http --url=${NGROK_URL} 80
    #   # 접근 제한(권장): Basic Auth
    #   # - "--basic-auth=${NGROK_BASIC_AUTH}"
    #   # 헤더 보존/프록시 관련(선택)
    #   # - "--host-header=rewrite"
    # depends_on:
    #   - nginx
    
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: cloudflared
  #   command: tunnel run
  #   restart: unless-stopped
  #   volumes:
  #     - ./cloudflared:/etc/cloudflared

  nginx:
    container_name: nginx
    image: nginx:1.25.3
    depends_on:
      - frontend
      - backend
    ports:
      - "80:80"
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app_net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_BASE=/api
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      - WATCHPACK_POLLING=true
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - app_net
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=postgresql+psycopg://postgres:${POSTGRES_PASSWORD}@db:5432/db
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - ./backend:/app
    depends_on:
      - db
    networks:
      - app_net
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  db:
    image: pgvector/pgvector:pg16
    container_name: db
    environment:
      - POSTGRES_DB=db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - TZ=Asia/Seoul
    volumes:
      - ./db:/var/lib/postgresql/data
    networks:
      - app_net
    restart: unless-stopped
    # 외부 노출 불필요(권장)
    # ports:
    #   - "5432:5432"

volumes:
  pgdata:

networks:
  app_net:
    driver: bridge
